<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventaire Stock</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>📦</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>📦</text></svg>">
    <style>
        body{ font-family: sans-serif; padding: 5px; background: #f4f4f4; max-width: 650px; margin: auto; }
        
        .formulaire{ 
            background: white; padding: 10px; border-radius: 8px; margin-bottom: 15px; 
            border: 1px solid #ddd; display: flex; gap: 5px; align-items: center;
        }
        input#nomInput{ flex: 2; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; min-width: 0; }
        input#qteInput{ width: 45px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; text-align: center; }
        .btn-ajout{ background: #0288d1; color: white; border: none; font-weight: bold; padding: 10px; border-radius: 4px; cursor: pointer; }

        .carte-objet{ 
            background: white; border: 1px solid #ddd; 
            padding: 5px 2px 5px 8px; 
            margin-bottom: 4px; 
            border-radius: 6px; display: flex; align-items: center; justify-content: space-between;
            height: 45px; 
        }
        
        .nom-objet{ 
            font-weight: bold; /* LE GRAS EST DE RETOUR */
            color: #333; 
            flex: 1; min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 16px; /* Taille normale pour les noms courts */
            margin-right: 2px;
        }
        
        /* On n'applique la réduction que si l'écran est petit (max 500px) */
        @media (max-width: 500px) {
            .nom-objet.petite-police {
                font-size: 15px; /* Un peu plus petit pour compenser l'emoji */
                letter-spacing: -0.5px;
            }
        }

        .controles{ display: flex; align-items: center; gap: 2px; flex-shrink: 0; }
        .badge{ background: #e1f5fe; padding: 8px 0; border-radius: 4px; font-weight: bold; color: #0288d1; min-width: 32px; text-align: center; font-size: 0.9em; }
        button{ cursor: pointer; padding: 10px 0; border: 1px solid #ccc; background: white; border-radius: 4px; font-size: 14px; min-width: 32px; text-align: center; }
        button:active{ background: #e0e0e0; }
        .btn-poubelle{ border: none; background: none; font-size: 1.2em; cursor: pointer; padding: 0 5px; flex-shrink: 0; }
    </style>
</head>
<body>

    <h2>📦 Gestion de Stock</h2>

    <div class="formulaire">
        <input type="text" id="nomInput" placeholder="Nouvel article...">
        <input type="number" id="qteInput" placeholder="Qté" style="width: 60px;">
        <button class="btn-ajout" onclick="CreerFourniture()">Ajouter</button>
    </div>

    <div id="liste-fournitures">Connexion au stock...</div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBQvf0Xvl6_6p84fwSywgksdHhnv9scq68",
            databaseURL: "https://inventaire-stock-5fe28-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "inventaire-stock-5fe28",
            appId: "1:984675783814:web:c4479fd570b76992f0ed07"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- GESTION DU SECRET VIA URL ---
        const params = new URLSearchParams(window.location.search);
        const codeUrl = params.get('code');
        if (codeUrl){
            localStorage.setItem('secret_stock', codeUrl);
            window.history.replaceState({}, document.title, window.location.pathname);
        }
        let monSecret = localStorage.getItem('secret_stock') || "";
        // ---------------------------------

        // public
        function AfficherInterface (data){
            const conteneur = document.getElementById('liste-fournitures');
            if (!data){
                conteneur.innerHTML = "<i>Le stock est vide.</i>";
                return;
            }

            // Fonction pour trouver l'emoji selon le nom
            const getEmoji = (nom) => {
                const n = nom.toLowerCase();
                if (n.includes("assiette")) return "🍽️ ";
                if (n.includes("drap") || n.includes("housse") || n.includes("linge") || n.includes("serviette")) return "🧺 ";
                if (n.includes("verre") || n.includes("gobelet")) return "🥛 ";
                if (n.includes("couvert") || n.includes("fourchette") || n.includes("couteau")) return "🍴 ";
                if (n.includes("savon") || n.includes("douche") || n.includes("shampoing")) return "🧼 ";
                if (n.includes("papier") || n.includes("toilette") || n.includes("sopalin")) return "🧻 ";
                if (n.includes("tasse")) return "☕ ";
                return "📦 "; // Emoji par défaut si rien ne correspond
            };

            const tableauTrie = Object.keys(data).map(id => ({
                id: id,
                ...data[id]
            }));

            tableauTrie.sort((a, b) => a.n.localeCompare(b.n));

            conteneur.innerHTML = "";
            tableauTrie.forEach((f) => {
                const div = document.createElement('div');
                div.className = "carte-objet";
                
                // On vérifie la longueur (on compte l'emoji dedans ou pas selon ton goût)
                // Ici on garde 15, l'emoji est ajouté juste au moment du texte
                let classeTaille = (f.n.length > 15) ? "petite-police" : "";
                let emoji = getEmoji(f.n);

                div.innerHTML = `
                    <div class="nom-objet ${classeTaille}">${emoji}${f.n}</div>
                    <div class="controles">
                        <button onclick="ChangerQuantite('${f.id}', -5)">-5</button>
                        <button onclick="ChangerQuantite('${f.id}', -1)">-1</button>
                        <span class="badge">${f.q}</span>
                        <button onclick="ChangerQuantite('${f.id}', 1)">+1</button>
                        <button onclick="ChangerQuantite('${f.id}', 5)">+5</button>
                        <button class="btn-poubelle" onclick="SupprimerFourniture('${f.id}', '${f.n}')">🗑️</button>
                    </div>
                `;
                conteneur.appendChild(div);
            });
        }

        function EcouterStock(){
            db.ref('fournitures').on('value', (snap) => {
                AfficherInterface(snap.val());
            });
        }

        function CreerFourniture(){
            if (monSecret == ""){ alert("Erreur : Aucun code secret configuré."); return; }
            const nomInput = document.getElementById('nomInput');
            const qteInput = document.getElementById('qteInput');
            
            const n = nomInput.value.trim();
            let q = parseInt(qteInput.value);
            
            // Si le champ quantité est vide ou n'est pas un chiffre, on met 0
            if (isNaN(q)){
                q = 0;
            }
            
            if (n != ""){
                db.ref('fournitures').push({ n: n, q: q, secret: monSecret });
                
                // On vide les champs
                nomInput.value = "";
                qteInput.value = "";
                
                // On force la fermeture du clavier sur mobile
                nomInput.blur();
                qteInput.blur();
            } else {
                alert("Veuillez entrer un nom de fourniture.");
            }
        }

        function ChangerQuantite (id, delta){
            if (monSecret == ""){ alert("Erreur : Aucun code secret configuré."); return; }
            const ref = db.ref('fournitures/' + id);
            ref.once('value').then((snap) => {
                let nv = (snap.val().q || 0) + delta;
                if (nv < 0) nv = 0;
                ref.update({ q: nv, secret: monSecret });
            });
        }

        function SupprimerFourniture (id, nom){
            if (monSecret == ""){ alert("Erreur : Aucun code secret configuré."); return; }
            if (confirm("Supprimer définitivement '" + nom + "' ?")){
                db.ref('fournitures/' + id).remove();
            }
        }

        function SauvegarderBDD(){
            if (monSecret == ""){ alert("Erreur : Aucun code secret configuré."); return; }
            
            db.ref('fournitures').once('value').then((snap) => {
                const data = snap.val();
                if (!data){ alert("Le stock est vide, rien à sauvegarder."); return; }

                const contenu = JSON.stringify(data, null, 2);
                const blob = new Blob([contenu], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const date = new Date().toISOString().split('T')[0];
                const lien = document.createElement('a');
                lien.href = url;
                lien.download = "stock_backup_" + date + ".json";
                lien.click();
                
                // Nettoyage
                setTimeout(() => URL.revokeObjectURL(url), 100);
            });
        }

        async function RestaurerBDD(event){
            if (monSecret == ""){ alert("Erreur : Aucun code secret configuré."); return; }
            const fichier = event.target.files[0];
            if (!fichier) return;

            const lecteur = new FileReader();
            lecteur.onload = async function(e){
                try {
                    const contenu = JSON.parse(e.target.result);
                    if (confirm("Restaurer les données ?")){
                        const ref = db.ref('fournitures');
                        for (let id in contenu) {
                            let article = contenu[id];
                            article.secret = monSecret;
                            await ref.child(id).set(article);
                        }
                        alert("Restauration terminée !");
                    }
                } catch (err){
                    alert("Erreur de format JSON.");
                }
                // --- AJOUTE CETTE LIGNE ICI ---
                event.target.value = ""; // Réinitialise le sélecteur
                // ------------------------------
            };
            lecteur.readAsText(fichier);
        }

        EcouterStock();
    </script>
    <div style="text-align: center; margin-top: 20px; border-top: 1px solid #ddd; padding-top: 10px;">
        <a href="#" onclick="SauvegarderBDD()" style="color: #bbb; font-size: 11px; text-decoration: none; margin: 0 10px;">📥 Sauvegarder</a>
        <label for="importFile" style="color: #bbb; font-size: 11px; cursor: pointer; text-decoration: none; margin: 0 10px;">📤 Restaurer
            <input type="file" id="importFile" accept=".json" onchange="RestaurerBDD(event)" style="display: none;">
        </label>
    </div>
</body>
</html>