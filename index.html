<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventaire Stock</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>📦</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>📦</text></svg>">
    <style>
        body{ font-family: sans-serif; padding: 5px; background: #f4f4f4; max-width: 650px; margin: auto; }
        
        /* FORMULAIRE PC */
        .formulaire{ 
            background: white; padding: 10px; border-radius: 8px; margin-bottom: 15px; 
            border: 1px solid #ddd; display: flex; gap: 8px; align-items: flex-end;
        }
        .champ-groupe{ display: flex; flex-direction: column; gap: 2px; }
        .champ-groupe label{ font-size: 11px; color: #666; font-weight: bold; margin-left: 2px; }
        
        .cg-nom{ flex: 1.5 !important; } 
        .cg-cat{ flex: 1.2 !important; }
        .cg-num{ flex: 0.5 !important; }
        .cg-btn{ flex: 0.6 !important; }

        .cg-loc {
            flex: 0.5 !important; /* Largeur pour A1, B2... */
            min-width: 55px;
        }

        input#nomInput{ width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; box-sizing: border-box; }
        .input-nombre{ width: 100%; padding: 10px 2px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; text-align: center; box-sizing: border-box; }
        select#catInput{ width: 100%; padding: 9px; border-radius: 4px; border: 1px solid #ccc; background: white; height: 40px; box-sizing: border-box; }
        .btn-ajout{ width: 100%; background: #0288d1; color: white; border: none; font-weight: bold; padding: 10px 15px; border-radius: 4px; cursor: pointer; height: 40px; }

        .input-nombre::placeholder{ color: transparent; }

        /* FILTRES */
        .zone-filtres{ margin-bottom: 10px; display: flex; gap: 5px; justify-content: center; }
        .zone-filtres button{ 
            flex: 1; padding: 10px 5px; font-size: 14px; cursor: pointer; border: 1px solid #ccc; 
            background: white; border-radius: 4px; display: flex; align-items: center; justify-content: center; gap: 5px;
        }

        /* --- SPECIFIQUE MOBILE (Écran < 550px) --- */
        @media (max-width: 550px){
            .formulaire{ padding: 5px; gap: 4px; align-items: center; }
            .champ-groupe label{ display: none; }
            
            /* Proportions pour le mode compact */
            .cg-nom{ flex: 1 !important; }
            .cg-cat{ flex: 0.55 !important; } /* Largeur juste pour l'emoji */
            .cg-num{ flex: 0.5 !important; }
            .cg-btn{ flex: 0.5 !important; }

            .cg-loc {
                flex: 0.4 !important; /* Largeur pour A1, B2... */
                min-width: 40px;
            }
            
            input#nomInput, select#catInput, .input-nombre{ min-width: 0; }
            
            /* On force l'affichage de l'emoji seul dans le select fermé */
            select#catInput{ font-size: 18px; padding: 5px; text-align: center; }
            
            .input-nombre::placeholder{ color: #aaa; }

            .btn-ajout span{ display: none; }
            .btn-ajout::after{ content: '+'; }
            
            /* Filtres : Emoji uniquement */
            .zone-filtres button span{ display: none; }
            .btn-vais::after, .btn-ling::after, .btn-meub::after, .btn-div::after{ content: '' !important; }
            .zone-filtres button{ font-size: 20px; padding: 10px 0; }

            /* Cache les boutons +/- 5 */
            .btn-5 {
                display: none !important;
            }

            /* Transforme les boutons +/- 1 en + et - */
            .btn-1 {
                font-size: 0 !important; /* Cache le texte "+1" ou "-1" */
                width: 30px !important;
                min-width: 30px !important;
            }

            .btn-1[onclick*="-1"]::before {
                content: "-";
                font-size: 16px;
            }

            .btn-1[onclick*=" 1"]::before { /* Note l'espace avant le 1 pour cibler le +1 */
                content: "+";
                font-size: 16px;
            }
            
            /* Le conteneur du nom doit utiliser flex pour pousser les badges */
            .nom-objet {
                display: flex !important;
                align-items: center;
                flex: 1;
                min-width: 0; /* Important pour que le texte se coupe avec ... */
                overflow: hidden;
                font-size: 13px !important;
                margin-right: 12px !important;
            }

            /* Le texte du nom prend tout l'espace libre */
            .nom-objet span:first-child {
                flex: 1;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                margin-right: 4px;
            }

            /* On s'assure que les badges ne rétrécissent pas */
            .badge-zone, .btn-voir-plan {
                flex-shrink: 0;
                font-size: 10px; /* On réduit aussi un peu les badges pour gagner de la place */
                padding: 1px 4px;
            }
        }

        @media (min-width: 768px) {
            .label-cat {
                font-size: 0 !important; /* Force la disparition du texte "Cat." */
            }
            .label-cat::before {
                content: "Catégorie";
                font-size: 14px !important; /* Force l'affichage du mot complet */
                display: inline-block;
            }
        }

        /* LISTE */
        .carte-objet{ background: white; border: 1px solid #ddd; padding: 5px 2px 5px 8px; margin-bottom: 4px; border-radius: 6px; display: flex; align-items: center; justify-content: space-between; height: 45px; }
        .nom-objet{ font-weight: bold; color: #333; flex: 1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 16px; margin-right: 2px; }
        .alerte-icone{ color: #e53935; margin-left: 5px; font-size: 14px; }
        .controles{ display: flex; align-items: center; gap: 2px; flex-shrink: 0; }
        .badge{ background: #e1f5fe; padding: 8px 0; border-radius: 4px; font-weight: bold; color: #0288d1; min-width: 32px; text-align: center; font-size: 0.9em; }
        button.ctrl-btn{ cursor: pointer; padding: 10px 0; border: 1px solid #ccc; background: white; border-radius: 4px; font-size: 14px; min-width: 32px; text-align: center; }
        .btn-poubelle{ border: none; background: none; font-size: 1.2em; cursor: pointer; padding: 0 5px; }
        .filtre-actif{ background: #0288d1 !important; color: white !important; border-color: #0288d1 !important; }
    
        .onglets{ display: flex; gap: 5px; margin-bottom: 10px; }
        .onglets button{ flex: 1; padding: 12px; border: none; background: #ddd; font-weight: bold; cursor: pointer; border-radius: 6px; }
        .onglet-active{ background: #0288d1 !important; color: white; }

        .cadre-photo{ position: relative; border: 2px solid #0288d1; border-radius: 10px; overflow: hidden; }
        .label-zone{ position: absolute; top: 5px; left: 5px; background: rgba(2, 136, 209, 0.8); color: white; padding: 3px 8px; font-size: 12px; font-weight: bold; border-radius: 4px; }
        .grille-niveaux{ position: absolute; right: 5px; top: 0; bottom: 0; display: flex; flex-direction: column; justify-content: space-around; color: white; font-weight: bold; text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000; }

        /* On supprime l'ancien badge-zone orange et on utilise ce style propre */
        .badge-zone, .badge-loc {
            background: #f1f3f4;
            color: #444;
            border: 1px solid #ccc;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px; /* On garde ta taille d'origine */
            font-weight: bold;
            margin-left: 5px;
            cursor: pointer;
            display: inline-block;
            vertical-align: middle;
        }

        .badge-zone:hover, .badge-loc:hover {
            background: #e8eaed;
            border-color: #999;
        }

        .btn-voir-plan {
            cursor: pointer;
            margin-left: 6px;
            display: inline-block;
            vertical-align: middle;
            font-size: 1.2em;
            filter: grayscale(0.5); /* Plus discret que la loupe bleue vive */
            transition: transform 0.1s;
        }

        .btn-voir-plan:hover {
            transform: scale(1.1);
            filter: grayscale(0);
        }
        
      /* 1. Le conteneur (ne change pas) */
        .zone-slider {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory; 
            gap: 0;
            padding: 0;
            scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }

        /* 2. C'est ICI qu'il faut mettre le frein (sur zone-item) */
        .zone-item {
            flex-shrink: 0;
            width: 100%;
            scroll-snap-align: center; 
            scroll-snap-stop: always; /* Force l'arrêt à chaque zone */
        }

        /* 3. L'image doit juste suivre la taille */
        .zone-item img {
            width: 100%;
            display: block;
        }

        .zone-slider::-webkit-scrollbar { display: none; }

        .zone-item{
            flex: 0 0 100%; /* Prend toute la largeur, une par une */
            scroll-snap-align: start;
            position: relative;
            box-sizing: border-box;
        }
        
        /* On garde la taille originale de l'image */
        .zone-item img{
            width: 100%;
            height: auto; 
            display: block;
            border-radius: 8px;
        }

        .conteneur-slider { position: relative; }
        
        .btn-nav {
            position: absolute; top: 50%; transform: translateY(-50%);
            background: rgba(0,0,0,0.4); color: white; border: none;
            width: 40px; height: 40px; border-radius: 50%; cursor: pointer;
            font-size: 20px; z-index: 10; display: flex; align-items: center; justify-content: center;
        }
        .btn-nav:hover { background: rgba(0,0,0,0.7); }
        .btn-prev { left: 10px; }
        .btn-next { right: 10px; }

        .nom-objet{ display: flex; align-items: center; width: 100%; overflow: hidden; }
        .nom-objet span:first-child{ flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; min-width: 0; }
        .badge-zone{ flex-shrink: 0; }

        /* Calque de surbrillance */
        .highlight-overlay {
            position: absolute;
            left: 0;
            width: 100%;
            height: 25%; /* 1/4 de l'image */
            background: rgba(255, 255, 0, 0.4); /* Jaune transparent */
            box-shadow: 0 0 20px 10px rgba(255, 255, 255, 0.5);
            pointer-events: none; /* Ne bloque pas le clic */
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 5;
        }

        /* L'effet de flash */
        .highlight-overlay.active {
            animation: flashEffect 1s ease-out;
        }

        @keyframes flashEffect {
            0% { opacity: 0; }
            30% { opacity: 1; background: rgba(255, 255, 255, 0.6); }
            100% { opacity: 0; }
        }

    </style>
</head>
<body>

    <div class="onglets">
        <button id="btnStock" class="onglet-active" onclick="ChangerOnglet('stock')">📦 Stock</button>
        <button id="btnPlan" onclick="ChangerOnglet('plan')">📍 Plan</button>
    </div>
    
    <div id="section-plan" style="display:none; margin-top:10px;">
        <div class="conteneur-slider">
            <button class="btn-nav btn-prev" onclick="SliderNav(-1)">❮</button>
            <button class="btn-nav btn-next" onclick="SliderNav(1)">❯</button>
            
            <div class="zone-slider" id="planSlider">
                <div class="zone-item">
                    <div class="cadre-photo" id="container-A">
                        <div class="highlight-overlay" id="flash-A"></div> <div class="label-zone">ZONE A (Divers)</div>
                        <img src="1.jpg">
                        <div class="grille-niveaux"><span>A4</span><span>A3</span><span>A2</span><span>A1</span></div>
                    </div>
                </div>

                <div class="zone-item">
                    <div class="cadre-photo" id="container-B">
                        <div class="highlight-overlay" id="flash-B"></div> <div class="label-zone">ZONE B (Vaisselle/Divers)</div>
                        <img src="2.jpg">
                        <div class="grille-niveaux"><span>B4</span><span>B3</span><span>B2</span><span>B1</span></div>
                    </div>
                </div>
                
                <div class="zone-item">
                    <div class="cadre-photo" id="container-C">
                        <div class="highlight-overlay" id="flash-C"></div> <div class="label-zone">ZONE C (Linge)</div>
                        <img src="3.jpg">
                        <div class="grille-niveaux"><span>C4</span><span>C3</span><span>C2</span><span>C1</span></div>
                    </div>
                </div>

                <div class="zone-item">
                    <div class="cadre-photo" id="container-D">
                        <div class="highlight-overlay" id="flash-D"></div> <div class="label-zone">ZONE D (Linge)</div>
                        <img src="4.jpg">
                        <div class="grille-niveaux"><span>D4</span><span>D3</span><span>D2</span><span>D1</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="section-stock">
        <div class="formulaire" id="formulaire-ajout">
            <div class="champ-groupe cg-nom">
                <label>Fourniture</label>
                <input type="text" id="nomInput" placeholder="Nom">
            </div>
            <div class="champ-groupe cg-cat">
                <label class="label-cat">Cat.</label>
                <select id="catInput">
                    <option value="Vaisselle" selected>🍽️ Vaisselle</option>
                    <option value="Linge">🧺 Linge</option>
                    <option value="Meuble">🗄️ Meuble</option>
                    <option value="Divers">📦 Divers</option>
                </select>
            </div>
            <div class="champ-groupe cg-num">
                <label>Qté</label>
                <input type="number" id="qteInput" class="input-nombre" min="0" value="" placeholder="Qté">
            </div>
            <div class="champ-groupe cg-num">
                <label>Min</label>
                <input type="number" id="seuilInput" class="input-nombre" min="0" value="" placeholder="Min">
            </div>

            <div class="champ-groupe cg-loc">
                <label>Loc.</label>
                <button type="button" id="locInputBtn" class="input-nombre" 
                        style="width:100%; height:35px; background:white; border:1px solid #ccc; border-radius:4px; font-weight:bold; color:#666;"
                        onclick="OuvrirGrilleAjout()">Pos</button>
            </div>
            
            <div class="champ-groupe cg-btn">
                <button class="btn-ajout" onclick="CreerFourniture()"><span>Ajouter</span></button>
            </div>
        </div>

        <div class="zone-filtres">
            <button onclick="ChangerFiltre('Tous')" class="filtre-actif ctrl-btn">Tous</button>
            <button onclick="ChangerFiltre('Vaisselle')" class="btn-vais ctrl-btn">🍽️ <span>Vaisselle</span></button>
            <button onclick="ChangerFiltre('Linge')" class="btn-ling ctrl-btn">🧺 <span>Linge</span></button>
            <button onclick="ChangerFiltre('Meuble')" class="btn-meub ctrl-btn">🗄️ <span>Meuble</span></button>
            <button onclick="ChangerFiltre('Divers')" class="btn-div ctrl-btn">📦 <span>Divers</span></button>
        </div>

        <div id="liste-fournitures">Connexion au stock...</div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBQvf0Xvl6_6p84fwSywgksdHhnv9scq68",
            databaseURL: "https://inventaire-stock-5fe28-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "inventaire-stock-5fe28",
            appId: "1:984675783814:web:c4479fd570b76992f0ed07"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let dernieresDonneesRecues = null;
        let filtreActuel = "Tous";

        const params = new URLSearchParams(window.location.search);
        const codeUrl = params.get('code');
        if (codeUrl){
            localStorage.setItem('secret_stock', codeUrl);
            window.history.replaceState({}, document.title, window.location.pathname);
        }
        let monSecret = localStorage.getItem('secret_stock') || "";

        // 1. On définit la base de données de mots-clés une seule fois
        const CONFIG_CATEGORIES = {
            "Vaisselle": {
                emoji: "🍽️ ",
                mots: ["assiette", "verre", "couvert", "gobelet", "tasse", "fourchette", "couteau", "cuillère"]
            },
            "Linge": {
                emoji: "🧺 ",
                mots: ["drap", "housse", "linge", "serviette", "taie", "alèse", "couette", "matelas", "torchon", "oreiller"]
            },
            "Meuble": {
                emoji: "🗄️ ",
                mots: ["meuble", "chaise", "table"]
            }
        };

        function AttribuerCategorieAuto(nom, catExistante){
            if (catExistante && catExistante !== "Divers") return catExistante;
            
            const n = nom.toLowerCase();
            // On cherche si un mot-clé correspond dans notre config
            for (const [cat, data] of Object.entries(CONFIG_CATEGORIES)){
                if (data.mots.some(mot => n.includes(mot))) return cat;
            }
            return "Divers";
        }

        function AfficherInterface(data){
            const conteneur = document.getElementById('liste-fournitures');
            if (!data) return;

            const ordreCat = { "Vaisselle": 1, "Linge": 2, "Meuble": 3, "Divers": 4 };

            const getEmoji = (nom) => {
                const n = nom.toLowerCase();
                for (const data of Object.values(CONFIG_CATEGORIES)){
                    if (data.mots.some(mot => n.includes(mot))) return data.emoji;
                }
                return "📦 ";
            };

            const tableauTrie = Object.keys(data).map(id => ({ id: id, ...data[id] }));

            tableauTrie.sort((a, b) => {
                const catA = AttribuerCategorieAuto(a.n, a.c);
                const catB = AttribuerCategorieAuto(b.n, b.c);
                
                if (ordreCat[catA] !== ordreCat[catB]){
                    return ordreCat[catA] - ordreCat[catB];
                }
                return a.n.localeCompare(b.n);
            });

            conteneur.innerHTML = "";
            tableauTrie.forEach((f) => {
                const catReelle = AttribuerCategorieAuto(f.n, f.c);
                if (filtreActuel !== "Tous" && catReelle !== filtreActuel) return;
                const seuilVrai = f.s || 0;
                const estEnAlerte = (seuilVrai > 0 && f.q < seuilVrai);
                const loc = f.l || "A1";
                const div = document.createElement('div');
                div.className = "carte-objet";
                if (estEnAlerte){ div.style.background = "#ffebee"; div.style.borderColor = "#ef9a9a"; }
                const iconeAlerte = estEnAlerte ? `<span class="alerte-icone">⚠️</span>` : "";
                div.innerHTML = `
                    <div class="nom-objet">
                        <span onclick="ModifierSeuil('${f.id}', ${seuilVrai})" style="cursor:help">${getEmoji(f.n)}${f.n}</span>
                        <span class="badge-zone" onclick="ChangerZoneManuel('${f.id}', '${loc}')">📍 ${loc}</span>
                        <span onclick="OuvrirPlanZone('${loc}')" style="cursor:pointer; margin-left:8px;">🔍</span>
                        ${iconeAlerte}
                    </div>
                    <div class="controles">
                        <button class="ctrl-btn btn-5" onclick="ChangerQuantite('${f.id}', -5)">-5</button>
                        <button class="ctrl-btn btn-1" onclick="ChangerQuantite('${f.id}', -1)">-1</button>
                        <span class="badge">${f.q}</span>
                        <button class="ctrl-btn btn-1" onclick="ChangerQuantite('${f.id}', 1)">+1</button>
                        <button class="ctrl-btn btn-5" onclick="ChangerQuantite('${f.id}', 5)">+5</button>
                        <button class="btn-poubelle" onclick="SupprimerFourniture('${f.id}', '${f.n}')">🗑️</button>
                    </div>`;
                conteneur.appendChild(div);
            });
        }

        function CreerFourniture(){
            if (monSecret == ""){ alert("Erreur."); return; }
            const nomInput = document.getElementById('nomInput');
            const qteInput = document.getElementById('qteInput');
            const seuilInput = document.getElementById('seuilInput');
            const catInput = document.getElementById('catInput');
            const btnLoc = document.getElementById('locInputBtn');

            let n = nomInput.value.trim();
            const c = catInput.value;
            let q = parseInt(qteInput.value) || 0;
            let s = parseInt(seuilInput.value) || 0;
            
            // On vérifie d'abord si l'utilisateur a choisi une zone manuellement
            let l = (btnLoc.innerText === "Pos") ? "" : btnLoc.innerText;

            if (n != ""){
                // Mise en forme
                n = n.charAt(0).toUpperCase() + n.slice(1).toLowerCase();
                
                // SI aucune zone n'a été donnée (l est vide), on déclenche l'automatique
                if (l === ""){
                    l = AttribuerZoneAuto(n);
                }

                db.ref('fournitures').push({ 
                    n: n, q: q, s: s, c: c, l: l, secret: monSecret 
                });

                // Reset
                nomInput.value = ""; 
                qteInput.value = ""; 
                seuilInput.value = "";
                btnLoc.innerText = "Pos";
                btnLoc.style.color = "#aaa"; 
                btnLoc.style.borderColor = "#ccc";
                nomInput.blur();
            }
        }

        function ChangerQuantite (id, delta){
            db.ref('fournitures/' + id).once('value').then((snap) => {
                let nv = (snap.val().q || 0) + delta;
                if (nv < 0) nv = 0;
                db.ref('fournitures/' + id).update({ q: nv, secret: monSecret });
            });
        }

        function ModifierSeuil (id, actuelSeuil){
            const nouveauSeuil = prompt("Nouveau seuil d'alerte :", actuelSeuil);
            if (nouveauSeuil != null){
                const s = parseInt(nouveauSeuil);
                if (!isNaN(s) && s >= 0) db.ref('fournitures/' + id).update({ s: s });
            }
        }

        function SupprimerFourniture (id, nom){
            if (confirm("Supprimer '" + nom + "' ?")) db.ref('fournitures/' + id).remove();
        }

        function ChangerFiltre (nouvelleCategorie){
            filtreActuel = nouvelleCategorie;
            document.querySelectorAll('[onclick^="ChangerFiltre"]').forEach(btn => {
                if (btn.innerText.includes(nouvelleCategorie) || (nouvelleCategorie === 'Tous' && btn.innerText === 'Tous')) 
                    btn.classList.add('filtre-actif');
                else btn.classList.remove('filtre-actif');
            });
            AfficherInterface(dernieresDonneesRecues);
        }

        function ChangerOnglet (nom){
            const isStock = (nom == "stock");
            document.getElementById('section-stock').style.display = isStock ? "block" : "none";
            document.getElementById('formulaire-ajout').style.display = isStock ? "flex" : "none";
            document.getElementById('section-plan').style.display = isStock ? "none" : "block";
            
            document.getElementById('btnStock').className = isStock ? "onglet-active" : "";
            document.getElementById('btnPlan').className = isStock ? "" : "onglet-active";
        }

        function ChangerZoneManuel(id, zoneActuelle){
            // 1. Créer un voile sombre en arrière-plan
            const overlay = document.createElement("div");
            overlay.style = "position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:1000; display:flex; align-items:center; justify-content:center; padding:20px; box-sizing:border-box;";
            
            // 2. Créer le menu de sélection
            const menu = document.createElement("div");
            menu.style = "background:white; padding:15px; border-radius:12px; width:100%; max-width:300px; text-align:center;";
            menu.innerHTML = "<h3 style='margin-top:0; font-size:16px;'>Choisir une Zone</h3>";

            const grille = document.createElement("div");
            grille.style = "display:grid; grid-template-columns:repeat(4, 1fr); gap:8px; margin-bottom:15px;";

            const zones = [
                "A1","A2","A3","A4",
                "B1","B2","B3","B4",
                "C1","C2","C3","C4",
                "D1","D2","D3","D4"
            ];

            zones.forEach(z => {
                const btn = document.createElement("button");
                btn.innerText = z;
                btn.style = `padding:10px 5px; border:1px solid #ccc; border-radius:6px; background:${z === zoneActuelle ? '#4CAF50' : '#f9f9f9'}; color:${z === zoneActuelle ? 'white' : '#333'}; font-weight:bold; cursor:pointer;`;
                
                btn.onclick = () => {
                    if (z !== zoneActuelle){
                        db.ref('fournitures/' + id).update({ l: z });
                    }
                    document.body.removeChild(overlay);
                };
                grille.appendChild(btn);
            });

            menu.appendChild(grille);

            // Bouton Annuler
            const btnAnnuler = document.createElement("button");
            btnAnnuler.innerText = "Annuler";
            btnAnnuler.style = "width:100%; padding:10px; border:none; background:#eee; border-radius:6px; cursor:pointer;";
            btnAnnuler.onclick = () => document.body.removeChild(overlay);
            menu.appendChild(btnAnnuler);

            overlay.appendChild(menu);
            document.body.appendChild(overlay);
        }

        function OuvrirGrilleAjout(){
            const btnLoc = document.getElementById('locInputBtn');
            const zoneActuelle = btnLoc.innerText;

            const overlay = document.createElement("div");
            overlay.style = "position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:2000; display:flex; align-items:center; justify-content:center; padding:20px; box-sizing:border-box;";
            
            const menu = document.createElement("div");
            menu.style = "background:white; padding:15px; border-radius:12px; width:100%; max-width:300px; text-align:center;";
            menu.innerHTML = "<h3 style='margin-top:0; font-size:16px;'>Position de la fourniture</h3>";

            const grille = document.createElement("div");
            grille.style = "display:grid; grid-template-columns:repeat(4, 1fr); gap:8px; margin-bottom:15px;";

            const zones = ["A1","A2","A3","A4","B1","B2","B3","B4","C1","C2","C3","C4","D1","D2","D3","D4"];

            zones.forEach(z => {
                const btn = document.createElement("button");
                btn.innerText = z;
                btn.style = `padding:10px 5px; border:1px solid #ccc; border-radius:6px; background:${z === zoneActuelle ? '#4CAF50' : '#f9f9f9'}; color:${z === zoneActuelle ? 'white' : '#333'}; font-weight:bold; cursor:pointer;`;
                
                btn.onclick = () => {
                    btnLoc.innerText = z; 
                    btnLoc.style.color = "#333"; 
                    btnLoc.style.borderColor = "#4CAF50"; 
                    document.body.removeChild(overlay);
                };
                grille.appendChild(btn);
            });

            menu.appendChild(grille);

            // Bouton Annuler avec RESET
            const btnAnnuler = document.createElement("button");
            btnAnnuler.innerText = "Annuler";
            btnAnnuler.style = "width:100%; padding:10px; border:none; background:#eee; border-radius:6px; cursor:pointer; font-weight:bold; color:#666;";
            
            btnAnnuler.onclick = () => {
                // RESET du bouton principal
                btnLoc.innerText = "Pos";
                btnLoc.style.color = "#aaa"; 
                btnLoc.style.borderColor = "#ccc";
                document.body.removeChild(overlay);
            };

            menu.appendChild(btnAnnuler);
            overlay.appendChild(menu);
            document.body.appendChild(overlay);
        }

        function AttribuerZoneAuto (nom){ // doit trigger que si aucune zone n'a été donnée
            const n = nom.toLowerCase();
            if (n.includes("drap") || n.includes("linge") || n.includes("meuble")) return "A1";
            if (n.includes("assiette") || n.includes("verre")) return "B2";
            if (n.includes("chaise") || n.includes("table")) return "C1";
            if (n.includes("housse") || n.includes("serviette") || n.includes("torchon")) return "C2";
            if (n.includes("alèse") || n.includes("couette") || n.includes("matelas")) return "C3";
            if (n.includes("oreiller") || n.includes("table")) return "D2";
            return "A1";
        }

        

        // Navigation par flèches (clic)
        function SliderNav (direction){
            const slider = document.getElementById('planSlider');
            const scrollAmount = slider.clientWidth; // Défilement d'une largeur exacte
            slider.scrollBy({ left: direction * scrollAmount, behavior: 'smooth' });
        }

        // Navigation par clavier (flèches gauche/droite)
        window.addEventListener('keydown', (e) => {
            // On ne s'active que si l'onglet Plan est visible
            if (document.getElementById('section-plan').style.display === "block"){
                if (e.key === "ArrowLeft") SliderNav(-1);
                if (e.key === "ArrowRight") SliderNav(1);
            }
        });

        function OuvrirPlanZone(localisation){
            if (!localisation || localisation.length < 2) return;
            
            const lettre = localisation.charAt(0).toUpperCase();
            const niveau = parseInt(localisation.charAt(1));
            const index = lettre.charCodeAt(0) - 65; 
            const slider = document.getElementById('planSlider');

            if (slider){
                // 1. On cache le contenu du slider pour que le défilement soit invisible
                slider.style.opacity = "0";
                
                // 2. On affiche l'onglet
                ChangerOnglet('plan');

                setTimeout(() => {
                    const largeur = slider.clientWidth;
                    
                    // 3. On coupe tout ce qui peut créer une animation
                    slider.style.scrollBehavior = "auto";
                    slider.style.scrollSnapType = "none";
                    
                    // 4. On déplace
                    slider.scrollLeft = index * largeur;

                    // 5. On prépare le flash
                    const flash = document.getElementById('flash-' + lettre);
                    if (flash && niveau >= 1 && niveau <= 4){
                        const positions = { 1: "75%", 2: "50%", 3: "25%", 4: "0%" };
                        flash.style.top = positions[niveau];
                        flash.classList.remove('active');
                    }

                    // 6. On ré-affiche et on lance le flash
                    requestAnimationFrame(() => {
                        slider.style.opacity = "1"; // On remonte le rideau
                        if (flash) {
                            void flash.offsetWidth;
                            flash.classList.add('active');
                        }
                        slider.style.scrollSnapType = "x mandatory";
                    });
                    
                }, 30); // Un peu plus long pour être sûr que le rendu a commencé
            }
        }

        db.ref('fournitures').on('value', (snap) => {
            dernieresDonneesRecues = snap.val();
            AfficherInterface(dernieresDonneesRecues);
        });

        function SauvegarderBDD(){
            db.ref('fournitures').once('value').then((snap) => {
                const data = snap.val();
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const lien = document.createElement('a');
                lien.href = url; lien.download = "stock_backup.json"; lien.click();
            });
        }

        async function RestaurerBDD (event){
            const fichier = event.target.files[0];
            if (!fichier) return;
            const lecteur = new FileReader();
            lecteur.onload = async function(e){
                try {
                    const contenu = JSON.parse(e.target.result);
                    if (confirm("Restaurer ?")){
                        const ref = db.ref('fournitures');
                        let updates = {};
                        for (let id in contenu){
                            let article = contenu[id];
                            article.secret = monSecret;
                            updates[id] = article;
                        }
                        await ref.set(updates);
                    }
                } catch (err){ alert("Erreur JSON."); }
            };
            lecteur.readAsText(fichier);
        }


    </script>
    
    <div style="text-align: center; margin-top: 20px; border-top: 1px solid #ddd; padding-top: 10px;">
        <a href="#" onclick="SauvegarderBDD()" style="color: #bbb; font-size: 11px; text-decoration: none; margin: 0 10px;">📥 Sauvegarder</a>
        <label for="importFile" style="color: #bbb; font-size: 11px; cursor: pointer; text-decoration: none; margin: 0 10px;">📤 Restaurer
            <input type="file" id="importFile" accept=".json" onchange="RestaurerBDD(event)" style="display: none;">
        </label>
    </div>
</body>
</html>