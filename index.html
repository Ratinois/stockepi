<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventaire Stock</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>📦</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>📦</text></svg>">
    <style>
        body{ font-family: sans-serif; padding: 5px; background: #f4f4f4; max-width: 650px; margin: auto; }
        
        /* FORMULAIRE PC */
        .formulaire{ 
            background: white; padding: 10px; border-radius: 8px; margin-bottom: 15px; 
            border: 1px solid #ddd; display: flex; gap: 8px; align-items: flex-end;
        }
        .champ-groupe { display: flex; flex-direction: column; gap: 2px; }
        .champ-groupe label { font-size: 11px; color: #666; font-weight: bold; margin-left: 2px; }
        
        .cg-nom { flex: 1.5 !important; } 
        .cg-cat { flex: 1.2 !important; }
        .cg-num { flex: 0.5 !important; }
        .cg-btn { flex: 0.6 !important; }

        input#nomInput{ width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; box-sizing: border-box; }
        .input-nombre{ width: 100%; padding: 10px 2px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; text-align: center; box-sizing: border-box; }
        select#catInput { width: 100%; padding: 9px; border-radius: 4px; border: 1px solid #ccc; background: white; height: 40px; box-sizing: border-box; }
        .btn-ajout{ width: 100%; background: #0288d1; color: white; border: none; font-weight: bold; padding: 10px 15px; border-radius: 4px; cursor: pointer; height: 40px; }

        .input-nombre::placeholder { color: transparent; }

        /* FILTRES */
        .zone-filtres { margin-bottom: 10px; display: flex; gap: 5px; justify-content: center; }
        .zone-filtres button { 
            flex: 1; padding: 10px 5px; font-size: 14px; cursor: pointer; border: 1px solid #ccc; 
            background: white; border-radius: 4px; display: flex; align-items: center; justify-content: center; gap: 5px;
        }

        /* --- SPECIFIQUE MOBILE (Écran < 550px) --- */
        @media (max-width: 550px) {
            .formulaire { padding: 5px; gap: 4px; align-items: center; }
            .champ-groupe label { display: none; }
            
            /* Proportions pour le mode compact */
            .cg-nom { flex: 1.5 !important; }
            .cg-cat { flex: 0.55 !important; } /* Largeur juste pour l'emoji */
            .cg-num { flex: 0.5 !important; }
            .cg-btn { flex: 0.5 !important; }
            
            input#nomInput, select#catInput, .input-nombre { min-width: 0; }
            
            /* On force l'affichage de l'emoji seul dans le select fermé */
            select#catInput { font-size: 18px; padding: 5px; text-align: center; }
            
            .input-nombre::placeholder { color: #aaa; }

            .btn-ajout span { display: none; }
            .btn-ajout::after { content: '+'; }
            
            /* Filtres : Emoji uniquement */
            .zone-filtres button span { display: none; }
            .btn-vais::after, .btn-ling::after, .btn-meub::after, .btn-div::after { content: '' !important; }
            .zone-filtres button { font-size: 20px; padding: 10px 0; }
        }

        /* LISTE */
        .carte-objet{ background: white; border: 1px solid #ddd; padding: 5px 2px 5px 8px; margin-bottom: 4px; border-radius: 6px; display: flex; align-items: center; justify-content: space-between; height: 45px; }
        .nom-objet{ font-weight: bold; color: #333; flex: 1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 16px; margin-right: 2px; }
        .alerte-icone { color: #e53935; margin-left: 5px; font-size: 14px; }
        .controles{ display: flex; align-items: center; gap: 2px; flex-shrink: 0; }
        .badge{ background: #e1f5fe; padding: 8px 0; border-radius: 4px; font-weight: bold; color: #0288d1; min-width: 32px; text-align: center; font-size: 0.9em; }
        button.ctrl-btn{ cursor: pointer; padding: 10px 0; border: 1px solid #ccc; background: white; border-radius: 4px; font-size: 14px; min-width: 32px; text-align: center; }
        .btn-poubelle{ border: none; background: none; font-size: 1.2em; cursor: pointer; padding: 0 5px; }
        .filtre-actif { background: #0288d1 !important; color: white !important; border-color: #0288d1 !important; }
    </style>
</head>
<body>

    <h3 style="margin: 10px 0 10px 5px;">📦 Gestion de Stock</h3>

    <div class="formulaire">
        <div class="champ-groupe cg-nom">
            <label>Article</label>
            <input type="text" id="nomInput" placeholder="Nom">
        </div>
        <div class="champ-groupe cg-cat">
            <label>Cat.</label>
            <select id="catInput">
                <option value="Vaisselle" selected>🍽️ Vaisselle</option>
                <option value="Linge">🧺 Linge</option>
                <option value="Meuble">🗄️ Meuble</option>
                <option value="Divers">📦 Divers</option>
            </select>
        </div>
        <div class="champ-groupe cg-num">
            <label>Qté</label>
            <input type="number" id="qteInput" class="input-nombre" min="0" value="" placeholder="Qté">
        </div>
        <div class="champ-groupe cg-num">
            <label>Min</label>
            <input type="number" id="seuilInput" class="input-nombre" min="0" value="" placeholder="Min">
        </div>
        <div class="champ-groupe cg-btn">
            <button class="btn-ajout" onclick="CreerFourniture()"><span>Ajouter</span></button>
        </div>
    </div>

    <div class="zone-filtres">
        <button onclick="ChangerFiltre('Tous')" class="filtre-actif ctrl-btn">Tous</button>
        <button onclick="ChangerFiltre('Vaisselle')" class="btn-vais ctrl-btn">🍽️ <span>Vaisselle</span></button>
        <button onclick="ChangerFiltre('Linge')" class="btn-ling ctrl-btn">🧺 <span>Linge</span></button>
        <button onclick="ChangerFiltre('Meuble')" class="btn-meub ctrl-btn">🗄️ <span>Meuble</span></button>
        <button onclick="ChangerFiltre('Divers')" class="btn-div ctrl-btn">📦 <span>Divers</span></button>
    </div>

    <div id="liste-fournitures">Connexion au stock...</div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBQvf0Xvl6_6p84fwSywgksdHhnv9scq68",
            databaseURL: "https://inventaire-stock-5fe28-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "inventaire-stock-5fe28",
            appId: "1:984675783814:web:c4479fd570b76992f0ed07"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let dernieresDonneesRecues = null;
        let filtreActuel = "Tous";

        const params = new URLSearchParams(window.location.search);
        const codeUrl = params.get('code');
        if (codeUrl){
            localStorage.setItem('secret_stock', codeUrl);
            window.history.replaceState({}, document.title, window.location.pathname);
        }
        let monSecret = localStorage.getItem('secret_stock') || "";

        function AttribuerCategorieAuto (nom, catExistante){
            if (catExistante && catExistante !== "Divers") return catExistante;
            const n = nom.toLowerCase();
            if (n.includes("assiette") || n.includes("verre") || n.includes("couvert") || n.includes("gobelet") || n.includes("tasse") || n.includes("fourchette")) return "Vaisselle";
            if (n.includes("drap") || n.includes("housse") || n.includes("linge") || n.includes("serviette") || n.includes("taie")) return "Linge";
            if (n.includes("meuble") || n.includes("chaise") || n.includes("table")) return "Meuble";
            return "Divers";
        }

        function AfficherInterface (data){
            const conteneur = document.getElementById('liste-fournitures');
            if (!data) return;

            // Définition de l'ordre de priorité des catégories
            const ordreCat = { "Vaisselle": 1, "Linge": 2, "Meuble": 3, "Divers": 4 };

            const getEmoji = (nom) => {
                const n = nom.toLowerCase();
                if (n.includes("assiette") || n.includes("verre") || n.includes("couvert") || n.includes("gobelet") || n.includes("tasse") || n.includes("fourchette")) return "🍽️ ";
                if (n.includes("drap") || n.includes("housse") || n.includes("linge") || n.includes("serviette") || n.includes("taie")) return "🧺 ";
                if (n.includes("meuble") || n.includes("chaise") || n.includes("table")) return "🗄️ ";
                return "📦 ";
            };

            const tableauTrie = Object.keys(data).map(id => ({ id: id, ...data[id] }));

            // TRI : Par catégorie d'abord, puis alphabétique
            tableauTrie.sort((a, b) => {
                const catA = AttribuerCategorieAuto(a.n, a.c);
                const catB = AttribuerCategorieAuto(b.n, b.c);
                
                if (ordreCat[catA] !== ordreCat[catB]) {
                    return ordreCat[catA] - ordreCat[catB];
                }
                return a.n.localeCompare(b.n);
            });

            conteneur.innerHTML = "";
            tableauTrie.forEach((f) => {
                const catReelle = AttribuerCategorieAuto(f.n, f.c);
                if (filtreActuel !== "Tous" && catReelle !== filtreActuel) return;
                const seuilVrai = f.s || 0;
                const estEnAlerte = (seuilVrai > 0 && f.q < seuilVrai);
                const div = document.createElement('div');
                div.className = "carte-objet";
                if (estEnAlerte) { div.style.background = "#ffebee"; div.style.borderColor = "#ef9a9a"; }
                const iconeAlerte = estEnAlerte ? `<span class="alerte-icone">⚠️</span>` : "";
                div.innerHTML = `
                    <div class="nom-objet">
                        <span onclick="ModifierSeuil('${f.id}', ${seuilVrai})" style="cursor:help">${getEmoji(f.n)}${f.n}</span>
                        ${iconeAlerte}
                    </div>
                    <div class="controles">
                        <button class="ctrl-btn" onclick="ChangerQuantite('${f.id}', -5)">-5</button>
                        <button class="ctrl-btn" onclick="ChangerQuantite('${f.id}', -1)">-1</button>
                        <span class="badge">${f.q}</span>
                        <button class="ctrl-btn" onclick="ChangerQuantite('${f.id}', 1)">+1</button>
                        <button class="ctrl-btn" onclick="ChangerQuantite('${f.id}', 5)">+5</button>
                        <button class="btn-poubelle" onclick="SupprimerFourniture('${f.id}', '${f.n}')">🗑️</button>
                    </div>`;
                conteneur.appendChild(div);
            });
        }

        function CreerFourniture (){
            if (monSecret == ""){ alert("Erreur."); return; }
            const nomInput = document.getElementById('nomInput');
            const qteInput = document.getElementById('qteInput');
            const seuilInput = document.getElementById('seuilInput');
            const catInput = document.getElementById('catInput');
            const n = nomInput.value.trim();
            const c = catInput.value;
            let q = parseInt(qteInput.value) || 0;
            let s = parseInt(seuilInput.value) || 0;
            if (n != ""){
                db.ref('fournitures').push({ n: n, q: q, s: s, c: c, secret: monSecret });
                nomInput.value = ""; qteInput.value = ""; seuilInput.value = "";
                nomInput.blur();
            }
        }

        function ChangerQuantite (id, delta){
            db.ref('fournitures/' + id).once('value').then((snap) => {
                let nv = (snap.val().q || 0) + delta;
                if (nv < 0) nv = 0;
                db.ref('fournitures/' + id).update({ q: nv, secret: monSecret });
            });
        }

        function ModifierSeuil (id, actuelSeuil){
            const nouveauSeuil = prompt("Nouveau seuil d'alerte :", actuelSeuil);
            if (nouveauSeuil != null){
                const s = parseInt(nouveauSeuil);
                if (!isNaN(s) && s >= 0) db.ref('fournitures/' + id).update({ s: s });
            }
        }

        function SupprimerFourniture (id, nom){
            if (confirm("Supprimer '" + nom + "' ?")) db.ref('fournitures/' + id).remove();
        }

        function ChangerFiltre (nouvelleCategorie){
            filtreActuel = nouvelleCategorie;
            document.querySelectorAll('[onclick^="ChangerFiltre"]').forEach(btn => {
                if (btn.innerText.includes(nouvelleCategorie) || (nouvelleCategorie==='Tous' && btn.innerText==='Tous')) 
                    btn.classList.add('filtre-actif');
                else btn.classList.remove('filtre-actif');
            });
            AfficherInterface(dernieresDonneesRecues);
        }

        db.ref('fournitures').on('value', (snap) => {
            dernieresDonneesRecues = snap.val();
            AfficherInterface(dernieresDonneesRecues);
        });

        function SauvegarderBDD (){
            db.ref('fournitures').once('value').then((snap) => {
                const data = snap.val();
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const lien = document.createElement('a');
                lien.href = url; lien.download = "stock_backup.json"; lien.click();
            });
        }

        async function RestaurerBDD (event){
            const fichier = event.target.files[0];
            if (!fichier) return;
            const lecteur = new FileReader();
            lecteur.onload = async function(e){
                try {
                    const contenu = JSON.parse(e.target.result);
                    if (confirm("Restaurer ?")){
                        const ref = db.ref('fournitures');
                        let updates = {};
                        for (let id in contenu){
                            let article = contenu[id];
                            article.secret = monSecret;
                            updates[id] = article;
                        }
                        await ref.set(updates);
                    }
                } catch (err){ alert("Erreur JSON."); }
            };
            lecteur.readAsText(fichier);
        }
    </script>
    
    <div style="text-align: center; margin-top: 20px; border-top: 1px solid #ddd; padding-top: 10px;">
        <a href="#" onclick="SauvegarderBDD()" style="color: #bbb; font-size: 11px; text-decoration: none; margin: 0 10px;">📥 Sauvegarder</a>
        <label for="importFile" style="color: #bbb; font-size: 11px; cursor: pointer; text-decoration: none; margin: 0 10px;">📤 Restaurer
            <input type="file" id="importFile" accept=".json" onchange="RestaurerBDD(event)" style="display: none;">
        </label>
    </div>
</body>
</html>