<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventaire Stock</title>
    <style>
        body{ font-family: sans-serif; padding: 20px; background: #f4f4f4; max-width: 650px; margin: auto; }
        .formulaire{ background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .carte-objet{ background: white; border: 1px solid #ddd; padding: 12px; margin-bottom: 8px; border-radius: 6px; display: flex; align-items: center; justify-content: space-between; }
        .nom-objet{ font-weight: bold; flex: 1; color: #333; }
        .badge{ background: #e1f5fe; padding: 6px 12px; border-radius: 6px; font-weight: bold; color: #0288d1; margin: 0 10px; min-width: 30px; text-align: center; }
        .controles{ display: flex; align-items: center; gap: 2px; }
        button{ cursor: pointer; padding: 8px 10px; border: 1px solid #ccc; background: white; border-radius: 4px; transition: 0.2s; }
        button:hover{ background: #f0f0f0; border-color: #999; }
        input{ padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin-right: 5px; }
        .btn-ajout{ background: #0288d1; color: white; border: none; font-weight: bold; padding: 8px 15px; }
        .btn-poubelle{ border: none; background: none; font-size: 1.2em; margin-left: 10px; filter: grayscale(1); }
        .btn-poubelle:hover{ filter: grayscale(0); transform: scale(1.2); }
    </style>
</head>
<body>

    <h2>📦 Gestion de Stock</h2>

    <div class="formulaire">
        <input type="text" id="nomInput" placeholder="Nouvel article...">
        <input type="number" id="qteInput" placeholder="Qté" style="width: 60px;">
        <button class="btn-ajout" onclick="CreerFourniture()">Ajouter</button>
    </div>

    <div id="liste-fournitures">Connexion au stock...</div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBQvf0Xvl6_6p84fwSywgksdHhnv9scq68",
            databaseURL: "https://inventaire-stock-5fe28-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "inventaire-stock-5fe28",
            appId: "1:984675783814:web:c4479fd570b76992f0ed07"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- GESTION DU SECRET VIA URL ---
        const params = new URLSearchParams(window.location.search);
        const codeUrl = params.get('code');
        if (codeUrl){
            localStorage.setItem('secret_stock', codeUrl);
            window.history.replaceState({}, document.title, window.location.pathname);
        }
        let monSecret = localStorage.getItem('secret_stock') || "";
        // ---------------------------------

        // public
        function AfficherInterface (data){
            const conteneur = document.getElementById('liste-fournitures');
            if (!data){
                conteneur.innerHTML = "<i>Le stock est vide.</i>";
                return;
            }

            const tableauTrie = Object.keys(data).map(id => ({
                id: id,
                ...data[id]
            }));

            tableauTrie.sort((a, b) => a.n.localeCompare(b.n));

            conteneur.innerHTML = "";
            tableauTrie.forEach((f) => {
                const div = document.createElement('div');
                div.className = "carte-objet";
                div.innerHTML = `
                    <div class="nom-objet">${f.n}</div>
                    <div class="controles">
                        <button onclick="ChangerQuantite('${f.id}', -10)">-10</button>
                        <button onclick="ChangerQuantite('${f.id}', -1)">-1</button>
                        <span class="badge">${f.q}</span>
                        <button onclick="ChangerQuantite('${f.id}', 1)">+1</button>
                        <button onclick="ChangerQuantite('${f.id}', 10)">+10</button>
                        <button class="btn-poubelle" onclick="SupprimerFourniture('${f.id}', '${f.n}')">🗑️</button>
                    </div>
                `;
                conteneur.appendChild(div);
            });
        }

        // public
        function EcouterStock(){
            db.ref('fournitures').on('value', (snap) => {
                AfficherInterface(snap.val());
            });
        }

        // public
        function CreerFourniture(){
            if (monSecret == ""){ alert("Erreur : Aucun code secret configuré."); return; }
            const n = document.getElementById('nomInput').value;
            const q = parseInt(document.getElementById('qteInput').value);
            
            if (n != "" && !isNaN(q)){
                db.ref('fournitures').push({ n: n, q: q, secret: monSecret });
                document.getElementById('nomInput').value = "";
                document.getElementById('qteInput').value = "";
            }
        }

        // public
        function ChangerQuantite (id, delta){
            if (monSecret == ""){ alert("Erreur : Aucun code secret configuré."); return; }
            const ref = db.ref('fournitures/' + id);
            ref.once('value').then((snap) => {
                let nv = (snap.val().q || 0) + delta;
                if (nv < 0) nv = 0;
                ref.update({ q: nv, secret: monSecret });
            });
        }

        // public
        function SupprimerFourniture (id, nom){
            if (monSecret == ""){ alert("Erreur : Aucun code secret configuré."); return; }
            if (confirm("Supprimer définitivement '" + nom + "' ?")){
                db.ref('fournitures/' + id).remove();
            }
        }

        EcouterStock();
    </script>
</body>
</html>